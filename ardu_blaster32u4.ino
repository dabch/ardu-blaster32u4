#include <util/delay.h>

const uint16_t DELAY = 5000;


const uint16_t pwm_table[1024] =
{
	0, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 10, 10, 10, 10, 10, 10, 10, 10, 10, 11, 11, 11, 11, 11, 11, 11, 11, 11, 12, 12, 12, 12, 12, 12, 12, 12, 13, 13, 13, 13, 13, 13, 13, 14, 14, 14, 14, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15, 16, 16, 16, 16, 16, 16, 17, 17, 17, 17, 17, 18, 18, 18, 18, 18, 18, 19, 19, 19, 19, 19, 20, 20, 20, 20, 21, 21, 21, 21, 21, 22, 22, 22, 22, 23, 23, 23, 23, 24, 24, 24, 24, 25, 25, 25, 25, 26, 26, 26, 26, 27, 27, 27, 28, 28, 28, 28, 29, 29, 29, 30, 30, 30, 31, 31, 31, 32, 32, 32, 33, 33, 33, 34, 34, 34, 35, 35, 35, 36, 36, 37, 37, 37, 38, 38, 39, 39, 39, 40, 40, 41, 41, 41, 42, 42, 43, 43, 44, 44, 45, 45, 46, 46, 47, 47, 47, 48, 49, 49, 50, 50, 51, 51, 52, 52, 53, 53, 54, 54, 55, 56, 56, 57, 57, 58, 59, 59, 60, 60, 61, 62, 62, 63, 64, 64, 65, 66, 66, 67, 68, 69, 69, 70, 71, 71, 72, 73, 74, 75, 75, 76, 77, 78, 79, 79, 80, 81, 82, 83, 84, 85, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100, 101, 102, 103, 104, 105, 106, 108, 109, 110, 111, 112, 113, 115, 116, 117, 118, 119, 121, 122, 123, 125, 126, 127, 129, 130, 131, 133, 134, 135, 137, 138, 140, 141, 143, 144, 146, 147, 149, 150, 152, 154, 155, 157, 158, 160, 162, 164, 165, 167, 169, 171, 172, 174, 176, 178, 180, 182, 184, 185, 187, 189, 191, 193, 195, 197, 200, 202, 204, 206, 208, 210, 213, 215, 217, 219, 222, 224, 226, 229, 231, 234, 236, 238, 241, 244, 246, 249, 251, 254, 257, 259, 262, 265, 268, 270, 273, 276, 279, 282, 285, 288, 291, 294, 297, 300, 303, 307, 310, 313, 316, 320, 323, 327, 330, 333, 337, 341, 344, 348, 351, 355, 359, 363, 366, 370, 374, 378, 382, 386, 390, 394, 398, 403, 407, 411, 416, 420, 424, 429, 433, 438, 443, 447, 452, 457, 461, 466, 471, 476, 481, 486, 491, 497, 502, 507, 512, 518, 523, 529, 534, 540, 546, 551, 557, 563, 569, 575, 581, 587, 593, 600, 606, 612, 619, 625, 632, 639, 645, 652, 659, 666, 673, 680, 687, 694, 702, 709, 717, 724, 732, 739, 747, 755, 763, 771, 779, 787, 796, 804, 813, 821, 830, 838, 847, 856, 865, 874, 884, 893, 902, 912, 921, 931, 941, 951, 961, 971, 981, 992, 1002, 1013, 1023, 1034, 1045, 1056, 1067, 1078, 1090, 1101, 1113, 1124, 1136, 1148, 1160, 1172, 1185, 1197, 1210, 1223, 1236, 1249, 1262, 1275, 1288, 1302, 1316, 1330, 1344, 1358, 1372, 1386, 1401, 1416, 1431, 1446, 1461, 1476, 1492, 1508, 1524, 1540, 1556, 1572, 1589, 1606, 1622, 1640, 1657, 1674, 1692, 1710, 1728, 1746, 1764, 1783, 1802, 1821, 1840, 1859, 1879, 1899, 1919, 1939, 1959, 1980, 2001, 2022, 2043, 2065, 2086, 2108, 2131, 2153, 2176, 2199, 2222, 2245, 2269, 2293, 2317, 2341, 2366, 2391, 2416, 2441, 2467, 2493, 2519, 2546, 2573, 2600, 2627, 2655, 2683, 2711, 2740, 2768, 2798, 2827, 2857, 2887, 2917, 2948, 2979, 3011, 3042, 3074, 3107, 3139, 3172, 3206, 3240, 3274, 3308, 3343, 3378, 3414, 3450, 3486, 3523, 3560, 3598, 3635, 3674, 3712, 3752, 3791, 3831, 3871, 3912, 3953, 3995, 4037, 4080, 4123, 4166, 4210, 4254, 4299, 4344, 4390, 4436, 4483, 4530, 4578, 4626, 4675, 4724, 4774, 4824, 4875, 4926, 4978, 5031, 5084, 5137, 5191, 5246, 5301, 5357, 5413, 5470, 5528, 5586, 5645, 5705, 5765, 5825, 5887, 5949, 6011, 6075, 6139, 6203, 6269, 6335, 6401, 6469, 6537, 6606, 6675, 6746, 6817, 6889, 6961, 7035, 7109, 7183, 7259, 7336, 7413, 7491, 7570, 7650, 7730, 7812, 7894, 7977, 8061, 8146, 8232, 8318, 8406, 8495, 8584, 8674, 8766, 8858, 8951, 9046, 9141, 9237, 9335, 9433, 9532, 9633, 9734, 9837, 9940, 10045, 10151, 10258, 10366, 10475, 10585, 10697, 10809, 10923, 11038, 11155, 11272, 11391, 11511, 11632, 11755, 11878, 12003, 12130, 12258, 12387, 12517, 12649, 12782, 12917, 13053, 13190, 13329, 13470, 13612, 13755, 13900, 14046, 14194, 14344, 14495, 14648, 14802, 14958, 15115, 15275, 15435, 15598, 15762, 15928, 16096, 16266, 16437, 16610, 16785, 16962, 17140, 17321, 17503, 17688, 17874, 18062, 18253, 18445, 18639, 18835, 19034, 19234, 19437, 19642, 19849, 20058, 20269, 20482, 20698, 20916, 21136, 21359, 21584, 21811, 22041, 22273, 22508, 22745, 22984, 23227, 23471, 23718, 23968, 24221, 24476, 24734, 24994, 25257, 25523, 25792, 26064, 26338, 26616, 26896, 27180, 27466, 27755, 28047, 28343, 28641, 28943, 29248, 29556, 29867, 30182, 30500, 30821, 31146, 31474, 31805, 32140, 32479, 32821, 33167, 33516, 33869, 34226, 34586, 34950, 35319, 35691, 36067, 36446, 36830, 37218, 37610, 38006, 38407, 38811, 39220, 39633, 40051, 40472, 40899, 41329, 41765, 42205, 42649, 43098, 43552, 44011, 44475, 44943, 45417, 45895, 46378, 46867, 47360, 47859, 48363, 48873, 49388, 49908, 50433, 50965, 51501, 52044, 52592, 53146, 53706, 54271, 54843, 55421, 56005, 56594, 57191, 57793, 58402, 59017, 59638, 60267, 60901, 61543, 62191, 62846, 63508, 64177, 64853, 65535
};

volatile uint16_t *ocr_registers[3] = {&OCR1A, &OCR1B, &OCR3A}; // has to be volatile since it's used in interrupts (otherwise we get a compiler error)


void setup() {
	Serial.begin(9600);
	Serial.println("begin");

	DDRB |= _BV(DDB5) | _BV(DDB6); // set pins 9 (PB5, OC1A) and 10 (PB6, OC1B) to output
	DDRC |= _BV(DDC6); // set pin 5 (PC6, OC3A) to output
	
	
	// Timer 1
	TCCR1A = _BV(WGM11); //| _BV(WGM10);
	TCCR1B = _BV(WGM13) | _BV(WGM12); // set waveform generation mode (WGM) to Fast PWM with ICR1A as top
	
	ICR1 = 0xFFFF; // set TOP to the maximum possible to reach 16bit resolution
	
	TCCR1B |= _BV(CS10); // start timer without prescaler
	
	//OCR1A = 0xFFFF;
	//OCR1B = 0xFFF;
	
	TCCR1A |= _BV(COM1A1); // connect pin 9 to timer 1 channel A
      TCCR1A |= _BV(COM1B1); // connect pin 10 to timer 1 channel B
      
      
      // Timer 3	
	TCCR3A = _BV(WGM31); //| _BV(WGM30);
	TCCR3B = _BV(WGM33) | _BV(WGM32); // set waveform generation mode (WGM) to Fast PWM with ICR1A as top
	
	ICR3 = 0xFFFF; // set TOP to the maximum possible to reach 16bit resolution
	
	TCCR3B |= _BV(CS30); // start timer without prescaler
	
	//OCR3A = 0xFFFF;
	
	TCCR3A |= _BV(COM3A1); // connect pin 5 to timer 3 channel A
}

void loop() {
	int brightness = 0;
	int pin = 0;
	//for(pin = 0; pin < 3; pin++) {
		for (brightness = 0; brightness < 1024; brightness++)
		{	
			//on	
			*ocr_registers[pin] = (pwm_table[brightness]);
			_delay_us(DELAY);
		}
		for (brightness = 0; brightness < 1024; brightness++)
		{	
			//on	
			*ocr_registers[pin] = (pwm_table[1023 - brightness]);
			_delay_us(DELAY);
		}
	//}
}
